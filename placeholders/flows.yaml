# BlackRoad Flow Definitions
# Document orchestration flows per environment
# Each flow captures triggers, steps, observers, and rollback guidance
staging:
  flows:
    - name: "deploy-prism-console-staging"
      description: "Coordinates staged deployment rollouts for Prism Console to staging environment."
      triggers:
        manual: true
        schedules:
          - cron: "0 */6 * * *"              # Every 6 hours
        sources:
          - type: "slack_command"
            value: "/deploy prism-console staging"
          - type: "github_webhook"
            value: "push:main"
      steps:
        - name: "build-artifacts"
          action: "github.workflow:build-prism-console"
          notes: "Builds Docker images and runs comprehensive test suite"
        - name: "deploy"
          action: "scripts/deploy-staging.sh"
          rollback: "scripts/rollback-staging.sh"
      observers:
        - channel: "#deploys"
          type: "slack"
      runbooks:
        - "docs/runbooks/deploy-staging.md"
production:
  flows:
    - name: "deploy-web-prod"
      description: "Promote latest artifact to production."
      prerequisites:
        - "Staging deploy successful"
        - "CAB approval recorded"
      triggers:
        manual: true
        approvals_required:
          - role: "sre-lead"
          - role: "product-owner"
      steps:
        - name: "preflight"
          action: "scripts/preflight.sh"
        - name: "deploy"
          action: "scripts/deploy-prod.sh"
        - name: "verify"
          action: "scripts/verify-prod.sh"
      rollback_plan:
        summary: "Automatic rollback to previous stable version if health checks fail"
        command: "scripts/rollback-prod.sh"
        triggers:
          - "Health check failure for >5 minutes"
          - "Error rate >5% for >2 minutes"
          - "Manual trigger via /rollback command"
      communications:
        - medium: "slack"
          target: "#status"
        - medium: "statuspage"
          target: "https://status.example.com"
