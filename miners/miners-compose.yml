version: '3.9'

x-default-constraints: &default-constraints
  cpus: 0.25
  mem_limit: 256m
  restart: unless-stopped
  read_only: true
  security_opt:
    - no-new-privileges:true
  networks:
    - miner-net

services:
  xmrig:
    image: ghcr.io/xmrig/xmrig:latest
    container_name: xmrig
    <<: *default-constraints
    command: >-
      -o ${XMR_POOL:-POOL_HOST:PORT}
      -u ${XMR_ADDRESS:-YOUR_XMR_ADDRESS}
      --tls
      --donate-level=0
      --cpu-max-threads-hint=${XMR_THREADS:-1}
      --http-host=0.0.0.0
      --http-port=18080
    environment:
      - XMRIG_ALGO=${XMRIG_ALGO:-rx/0}
    volumes:
      - /etc/localtime:/etc/localtime:ro

  p2pool:
    image: ghcr.io/schernykh/p2pool:release
    container_name: p2pool
    <<: *default-constraints
    command: >-
      --wallet ${P2POOL_WALLET:-YOUR_XMR_ADDRESS}
      --host ${P2POOL_MONEROD:-monerod:18081}
      --stratum ${P2POOL_STRATUM:-0.0.0.0:3333}
      --log-level 3
    ports:
      - "${P2POOL_STRATUM_PORT:-3333}:3333"

  miner-bridge:
    build:
      context: ../tools/miners
    container_name: miner-bridge
    restart: unless-stopped
    environment:
      PRISM_API: ${PRISM_API}
      PRISM_TOKEN: ${PRISM_TOKEN}
      PRISM_ORG_ID: ${PRISM_ORG_ID}
      MINER_AGENT_ID: ${MINER_AGENT_ID}
      XMRIG_URL: ${XMRIG_URL:-http://xmrig:18080/2/summary}
      POLL_INTERVAL_MS: ${POLL_INTERVAL_MS:-15000}
    depends_on:
      - xmrig
    networks:
      - miner-net

  verusminer:
    image: krypt0nn/verus-miner:latest
    container_name: verusminer
    <<: *default-constraints
    environment:
      - POOL=${VERUS_POOL:-POOL_HOST:PORT}
      - WALLET=${VERUS_ADDRESS:-YOUR_VRSC_ADDRESS}
      - PASSWORD=${VERUS_PASSWORD:-x}
      - THREADS=${VERUS_THREADS:-1}

  ltc-cpuminer:
    image: registry.gitlab.com/foss/cpuminer-multi:latest
    container_name: ltc-cpuminer
    <<: *default-constraints
    command: >-
      -a scrypt
      -o stratum+tcp://${LTC_POOL:-POOL_HOST:PORT}
      -u ${LTC_ADDRESS:-YOUR_LTC_ADDRESS}
      -p ${LTC_PASSWORD:-x}
      -t ${LTC_THREADS:-1}

  cpuminer-multi:
    image: registry.gitlab.com/foss/cpuminer-multi:latest
    container_name: cpuminer-multi
    <<: *default-constraints
    environment:
      - ALGO=${CPUMINER_ALGO:-verushash}
      - POOL=${CPUMINER_POOL:-POOL_HOST:PORT}
      - USER=${CPUMINER_USER:-YOUR_ADDRESS}
      - PASS=${CPUMINER_PASS:-x}
      - THREADS=${CPUMINER_THREADS:-1}
    command: >-
      -a ${ALGO}
      -o stratum+tcp://${POOL}
      -u ${USER}
      -p ${PASS}
      -t ${THREADS}

  chia:
    image: ghcr.io/chia-network/chia:latest
    container_name: chia
    cpus: 0.2
    mem_limit: 512m
    restart: unless-stopped
    read_only: false
    security_opt:
      - no-new-privileges:true
    networks:
      - miner-net
    environment:
      - keys=none
      - service=farm
      - log_level=${CHIA_LOG_LEVEL:-INFO}
      - TZ=${TZ:-UTC}
    volumes:
      - ./chia:/root/.chia
      - /mnt/plots:/plots:ro

networks:
  miner-net:
    driver: bridge
