version: "3.8"

# Low-power miner bundle. Every service is capped, read-only where possible, and
# requires manual activation. Copy to a device as ./miners-compose.yml and edit
# the placeholders before running:
#   docker compose -f miners-compose.yml up -d <service>
version: '3.9'

x-default-constraints: &default-constraints
  cpus: 0.25
  mem_limit: 256m
  restart: unless-stopped
  read_only: true
  security_opt:
    - no-new-privileges:true
  networks:
    - miner-net

services:
# Low-power miner bundle with optional telemetry bridge and local p2pool.
# Every service is opt-in. Edit the placeholders before enabling anything.
services:
  # --- Monero p2pool (optional local stratum template cache) ---
  p2pool:
    image: ghcr.io/sethforprivacy/p2pool:latest
    container_name: p2pool
    restart: unless-stopped
    command: >-
      --wallet ${XMR_ADDRESS:-YOUR_XMR_ADDRESS}
      --host 0.0.0.0
      --port 3333
      --rpc-port 37889
      --daemon ${MONEROD_HOST:-host.docker.internal:18089}
      --stratum 0.0.0.0:3333
      --mini
      --log-level 2
    environment:
      - P2POOL_DATA=/opt/p2pool
    ports:
      - "${P2POOL_PORT:-3333}:3333"
      - "${P2POOL_API_PORT:-37889}:37889"
    volumes:
      - p2pool-data:/opt/p2pool
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:37889/stats"]
      interval: 30s
      timeout: 5s
      retries: 10

  # --- Monero (xmrig) — CPU miner (learn-mode) ---
  xmrig:
    image: ghcr.io/xmrig/xmrig:latest
    container_name: xmrig
    <<: *default-constraints
    command: >-
      -o ${XMRIG_POOL:-POOL_HOST:PORT}
      -u ${XMRIG_WALLET:-YOUR_XMR_ADDRESS}
      --tls
      --donate-level=0
      --cpu-max-threads-hint=${XMRIG_THREADS_HINT:-1}
      -o ${XMR_POOL:-POOL_HOST:PORT}
      -u ${XMR_ADDRESS:-YOUR_XMR_ADDRESS}
      --tls
      --donate-level=0
      --cpu-max-threads-hint=${XMR_THREADS:-1}
      --http-host=0.0.0.0
      --http-port=18080
    environment:
      - XMRIG_ALGO=${XMRIG_ALGO:-rx/0}
    cpus: 0.25                # hard cap ≈25% of one core
    mem_limit: 256m
      -o ${XMR_POOL_HOST:-p2pool:3333}
      -u ${XMR_ADDRESS:-YOUR_XMR_ADDRESS}
      -p ${XMR_POOL_PASSWORD:-x}
      --algo=${XMRIG_ALGO:-rx/0}
      --donate-level=${XMRIG_DONATE_LEVEL:-0}
      --cpu-max-threads-hint=${XMRIG_THREAD_HINT:-1}
      --hugepages
      --http-enabled
      --http-host=0.0.0.0
      --http-port=18080
      --http-access-token=${XMRIG_HTTP_TOKEN:-}
      --http-no-restricted
      --api-worker-id=${XMRIG_WORKER_ID:-jetson}
    environment:
      - TZ=UTC
    cpus: ${XMRIG_CPUS:-0.5}
    mem_limit: ${XMRIG_MEM_LIMIT:-512m}
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    depends_on:
      - p2pool
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:18080/1/summary"]
      interval: 30s
      timeout: 5s
      retries: 5
    read_only: true
    tmpfs:
      - /tmp
    volumes:
      - /etc/localtime:/etc/localtime:ro
    ports:
      - "${XMRIG_HTTP_PORT:-18080}:18080"   # optional: expose the HTTP summary
    volumes:
      - /etc/localtime:/etc/localtime:ro

  p2pool:
    image: ghcr.io/schernykh/p2pool:release
    container_name: p2pool
    <<: *default-constraints
    command: >-
      --wallet ${P2POOL_WALLET:-YOUR_XMR_ADDRESS}
      --host ${P2POOL_MONEROD:-monerod:18081}
      --stratum ${P2POOL_STRATUM:-0.0.0.0:3333}
      --log-level 3
    ports:
      - "${P2POOL_STRATUM_PORT:-3333}:3333"

  miner-bridge:
    build:
      context: ../tools/miners
    container_name: miner-bridge
    restart: unless-stopped
    environment:
      PRISM_API: ${PRISM_API}
      PRISM_TOKEN: ${PRISM_TOKEN}
      PRISM_ORG_ID: ${PRISM_ORG_ID}
      MINER_AGENT_ID: ${MINER_AGENT_ID}
      XMRIG_URL: ${XMRIG_URL:-http://xmrig:18080/2/summary}
      POLL_INTERVAL_MS: ${POLL_INTERVAL_MS:-15000}
    depends_on:
      - xmrig
    networks:
      - miner-net

  # --- Miner bridge → Prism telemetry ---
  miner-bridge:
    image: python:3.11-slim
    container_name: miner-bridge
    restart: unless-stopped
    depends_on:
      - xmrig
    environment:
      - XMRIG_API_URL=http://xmrig:18080
      - XMRIG_API_TOKEN=${XMRIG_HTTP_TOKEN:-}
      - PRISM_API_URL=${PRISM_API_URL:-http://prism-console-api:4000}
      - PRISM_API_TOKEN=${PRISM_API_TOKEN:-}
      - MINER_ID=${MINER_ID:-xmrig}
      - POLL_INTERVAL=${MINER_BRIDGE_INTERVAL:-15}
      - LOG_LEVEL=${MINER_BRIDGE_LOG_LEVEL:-INFO}
    command: ["python", "-u", "/app/miner_bridge.py"]
    volumes:
      - ./bridge:/app:ro

  verusminer:
    image: krypt0nn/verus-miner:latest
    container_name: verusminer
    <<: *default-constraints
    environment:
      - POOL=${VERUS_POOL:-POOL_HOST:PORT}
      - WALLET=${VERUS_WALLET:-YOUR_VRSC_ADDRESS}
      - PASSWORD=${VERUS_PASSWORD:-x}
      - THREADS=${VERUS_THREADS:-1}
    command: >-
      --api-bind 0.0.0.0:4068
      - WALLET=${VERUS_ADDRESS:-YOUR_VRSC_ADDRESS}
      - PASSWORD=${VERUS_PASSWORD:-x}
      - THREADS=${VERUS_THREADS:-1}
    cpus: 0.25
    mem_limit: 256m
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    read_only: true
    ports:
      - "${VERUS_API_PORT:-4068}:4068"
      - WALLET=${VERUS_ADDRESS:-YOUR_VRSC_ADDRESS}
      - PASSWORD=${VERUS_PASSWORD:-x}
      - THREADS=${VERUS_THREADS:-1}

    profiles:
      - manual

  # --- Litecoin (scrypt CPU demo; educational only) ---
  ltc-cpuminer:
    image: registry.gitlab.com/foss/cpuminer-multi:latest
    container_name: ltc-cpuminer
    command: >-
      -a scrypt
      -o ${LTC_POOL:-stratum+tcp://POOL_HOST:PORT}
      -u ${LTC_WALLET:-YOUR_LTC_ADDRESS}
      -p ${LTC_PASSWORD:-x}
      -t ${LTC_THREADS:-1}
      --api-bind 0.0.0.0:4048
      -o stratum+tcp://${LTC_POOL:-POOL_HOST:PORT}
      -u ${LTC_ADDRESS:-YOUR_LTC_ADDRESS}
      -p ${LTC_PASSWORD:-x}
      -t ${LTC_THREADS:-1}
    cpus: 0.25
    mem_limit: 256m
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    read_only: true
    ports:
      - "${LTC_API_PORT:-4048}:4048"
    <<: *default-constraints
    command: >-
      -a scrypt
      -o stratum+tcp://${LTC_POOL:-POOL_HOST:PORT}
      -u ${LTC_ADDRESS:-YOUR_LTC_ADDRESS}
      -p ${LTC_PASSWORD:-x}
      -t ${LTC_THREADS:-1}
    profiles:
      - manual

  cpuminer-multi:
    image: registry.gitlab.com/foss/cpuminer-multi:latest
    container_name: cpuminer-multi
    <<: *default-constraints
    environment:
      - ALGO=${CPUMINER_ALGO:-verushash}
      - POOL=${CPUMINER_POOL:-POOL_HOST:PORT}
      - USER=${CPUMINER_USER:-YOUR_ADDRESS}
      - PASS=${CPUMINER_PASS:-x}
      - THREADS=${CPUMINER_THREADS:-1}
    command: >-
      -a ${ALGO}
      -o stratum+tcp://${POOL}
      -u ${USER}
      -p ${PASS}
      -t ${THREADS}
      --api-bind 0.0.0.0:4050
    command: >-
      -a ${CPUMINER_ALGO:-verushash}
      -o stratum+tcp://${CPUMINER_POOL:-POOL_HOST:PORT}
      -u ${CPUMINER_USER:-YOUR_ADDRESS}
      -p ${CPUMINER_PASS:-x}
      -t ${CPUMINER_THREADS:-1}
    cpus: 0.25
    mem_limit: 256m
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    read_only: true
    ports:
      - "${CPUMINER_API_PORT:-4050}:4050"

    profiles:
      - manual

  # --- Chia farmer (plots must already exist) ---
  chia:
    image: ghcr.io/chia-network/chia:latest
    container_name: chia
    environment:
      - keys=none            # do not load private keys on this host
      - service=farm         # farming only, no plotting
      - TZ=${TZ:-UTC}
      - log_level=${CHIA_LOG_LEVEL:-INFO}
    volumes:
      - ./chia:/root/.chia   # config + logs persisted locally
      - /mnt/plots:/plots:ro # mount pre-plotted drives read-only
      - keys=none
      - service=farm
      - log_level=INFO
      - TZ=UTC
    volumes:
      - ./chia:/root/.chia
      - /mnt/plots:/plots:ro
    cpus: 0.2
    mem_limit: 512m
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    read_only: false
    ports:
      - "${CHIA_RPC_PORT:-8555}:8555"

  # --- Miner bridge sidecar -> Prism events ---
  miner-bridge:
    image: node:20-alpine
    container_name: miner-bridge
    working_dir: /app
    volumes:
      - ./tools/miners:/app
    environment:
      PRISM_API: ${PRISM_API}
      PRISM_TOKEN: ${PRISM_TOKEN}
      PRISM_ORG_ID: ${PRISM_ORG_ID:-default}
      MINER_AGENT_ID: ${MINER_AGENT_ID:-miner:xmrig}
      XMRIG_URL: ${XMRIG_URL:-http://xmrig:18080/2/summary}
      XMRIG_POLL_MS: ${XMRIG_POLL_MS:-15000}
      VERUS_URL: ${VERUS_URL:-http://verusminer:4068}
      VERUS_POLL_MS: ${VERUS_POLL_MS:-20000}
      VERUS_AGENT_ID: ${VERUS_AGENT_ID:-miner:verus}
      LTC_URL: ${LTC_URL:-http://ltc-cpuminer:4048}
      LTC_POLL_MS: ${LTC_POLL_MS:-20000}
      LTC_AGENT_ID: ${LTC_AGENT_ID:-miner:ltc}
      CHIA_URL: ${CHIA_URL:-http://chia:8555/summary}
      CHIA_POLL_MS: ${CHIA_POLL_MS:-60000}
      CHIA_AGENT_ID: ${CHIA_AGENT_ID:-farmer:chia}
    command: ["sh", "-c", "npm install --omit=dev && node bridge.js"]
    depends_on:
      xmrig:
        condition: service_started
    restart: unless-stopped
    cpus: 0.2
    mem_limit: 512m
    restart: unless-stopped
    read_only: false
    security_opt:
      - no-new-privileges:true
    networks:
      - miner-net
    environment:
      - keys=none
      - service=farm
      - log_level=${CHIA_LOG_LEVEL:-INFO}
      - TZ=${TZ:-UTC}
    volumes:
      - ./chia:/root/.chia
      - /mnt/plots:/plots:ro

networks:
  miner-net:
    driver: bridge
    profiles:
      - manual

volumes:
  p2pool-data:
    driver: local
