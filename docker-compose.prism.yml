version: "3.9"

services:
  api:
    build: ./services/api
    container_name: api
    ports:
      - "4000:4000"
    volumes:
      - ./srv/blackroad-api/blackroad.db:/app/blackroad.db
    command: ["node", "server.mjs"]

  llm:
    build: ./srv/lucidia-llm
    container_name: llm
    ports:
      - "8000:8000"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 5s
      retries: 5

  math:
    build: ./srv/lucidia-math
    container_name: math
    ports:
      - "8500:8500"
    volumes:
      - math-output:/app/output
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8500/health"]
      interval: 30s
      timeout: 5s
      retries: 5

  nginx:
    image: nginx:alpine
    container_name: nginx
    ports:
      - "80:80"
    volumes:
      - ./nginx/prism.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - api
      - llm
      - math

volumes:
  math-output:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./srv/lucidia-math/output
    build: ./srv/blackroad-api
    container_name: blackroad-api
    restart: always
    env_file: .env
    ports:
      - "4000:4000"
    volumes:
      - blackroad-db:/srv/blackroad-api/blackroad.db

  nginx:
    image: nginx:alpine
    container_name: blackroad-nginx
    restart: always
    ports:
      - "80:80"
    volumes:
      - ./nginx/prism-api.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - api

volumes:
  blackroad-db:

