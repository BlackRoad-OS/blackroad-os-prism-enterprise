apiVersion: ops.blackroad.io/v1alpha1
kind: EnvironmentSet
metadata:
  service: prism-console
  owners:
    - platform@blackroad.io
  description: Canonical deploy surfaces for Prism Console across preview, staging, and production.
  documentation: DEPLOYMENT.md
environments:
  preview:
    summary: Ephemeral environments created per pull request for UI/UX validation and integration testing.
    lifecycle: ephemeral
    source:
      trigger: pull_request
      branches:
        - main
      workflow: .github/workflows/deploy-preview.yml
    targets:
      - name: prism-console-preview
        provider: fly.io
        app: prism-console-preview
        region: den
        release:
          strategy: rolling
          concurrency: 1
          resources:
            cpu: shared-cpu-1x
            memoryMB: 512
        artifact:
          type: container-image
          image: "ghcr.io/blackroad/prism-console:${{ github.sha }}"
        endpoints:
          - type: https
            url: "https://pr-${{ github.event.number }}.preview.blackroad.run"
      - name: roadview-search-preview
        provider: fly.io
        app: roadview-search-preview
        region: den
        release:
          strategy: rolling
          resources:
            cpu: shared-cpu-1x
            memoryMB: 512
        artifact:
          type: container-image
          image: "ghcr.io/blackroad/roadview-search:${{ github.sha }}"
        endpoints:
          - type: https
            url: "https://roadview.pr-${{ github.event.number }}.preview.blackroad.run"
        healthChecks:
          - path: /healthz
            intervalSeconds: 30
      - name: backroad-preview
        provider: nextjs-sim
        enabled: false
        notes: BackRoad portal ships as a gated Next.js experience; preview builds produce static stubs only.
      - name: lucidia-briefing-preview
        provider: docs-only
        enabled: false
        notes: Lucidia portal exposes prompt libraries and remains documentation-only in preview.
      - name: roadwork-preview
        provider: docs-only
        enabled: false
        notes: RoadWork learning portal renders from static documentation bundles.
      - name: roadglitch-preview
        provider: feature-flag
        enabled: false
        notes: Chaos toggles remain disabled; documentation is rendered for operator awareness.
      - name: roadcoin-simulation-preview
        provider: simulation
        enabled: false
        mode: simulation-only
        notes: RoadCoin remains a simulation-only sandbox; no custody features are provisioned.
    policies:
      promotion:
        requires:
          - status: lint
          - status: unit-tests
      rollback:
        runbook: RUNBOOK.md#preview-rollbacks
  staging:
    summary: Persistent environment for release candidate hardening and integration with managed services.
    lifecycle: persistent
    source:
      trigger: branch
      branches:
        - staging
      workflow: .github/workflows/deploy-staging.yml
    targets:
      - name: prism-console-staging
        provider: fly.io
        app: prism-console-staging
        region: ord
        release:
          strategy: rolling
          maxUnavailable: 1
          resources:
            cpu: performance-1x
            memoryMB: 1024
        artifact:
          type: container-image
          image: "ghcr.io/blackroad/prism-console:${{ github.sha }}"
        endpoints:
          - type: https
            url: "https://staging.console.blackroad.io"
      - name: roadview-search-staging
        provider: aws-ecs
        cluster: prism-shared-staging
        service: roadview-search
        region: us-east-1
        taskDefinition: roadview-search
        release:
          strategy: canary
          bakeTimeMinutes: 10
        endpoints:
          - type: https
            url: "https://roadview.staging.blackroad.io"
        healthChecks:
          - path: /healthz
            intervalSeconds: 30
      - name: backroad-staging
        provider: nextjs-sim
        enabled: false
        notes: BackRoad staging runs static review builds until feature flag approved.
      - name: lucidia-briefing-staging
        provider: docs-only
        enabled: false
        notes: Lucidia briefing surfaces link to internal prompts; no runtime services provisioned.
      - name: roadwork-staging
        provider: docs-only
        enabled: false
        notes: RoadWork remains read-only referencing the training corpus.
      - name: roadglitch-staging
        provider: feature-flag
        enabled: false
        notes: Chaos automation locked in staging pending ops review.
      - name: roadcoin-simulation-staging
        provider: simulation
        enabled: false
        mode: simulation-only
        notes: Simulation ledger replays transactions without custody integrations.
      - name: job-workers
        provider: aws-ecs
        cluster: prism-shared-staging
        service: prism-console-workers
        region: us-east-1
        taskDefinition: prism-console-workers
        release:
          strategy: canary
          bakeTimeMinutes: 15
          alarms:
            - arn: arn:aws:cloudwatch:us-east-1:123456789012:alarm:prism-console-worker-errors-staging
    policies:
      promotion:
        requires:
          - status: integration-tests
          - checklist: qa-signoff
          - checklist: security-review
      rollback:
        runbook: RUNBOOK.md#staging-rollbacks
  production:
    summary: Customer-facing environment serving prism.blackroad.io with failover automation.
    lifecycle: persistent
    source:
      trigger: release
      workflow: .github/workflows/deploy-prod.yml
    targets:
      - name: prism-console-prod-web
        provider: aws-ecs
        cluster: prism-shared-prod
        service: prism-console-web
        region: us-east-1
        taskDefinition: prism-console-web
        release:
          strategy: blue-green
          bakeTimeMinutes: 30
          approvals:
            - stakeholder: platform-lead
            - stakeholder: security
          alarms:
            - arn: arn:aws:cloudwatch:us-east-1:123456789012:alarm:prism-console-5xx-prod
            - arn: arn:aws:cloudwatch:us-east-1:123456789012:alarm:prism-console-latency-prod
        endpoints:
          - type: https
            url: "https://prism.blackroad.io"
      - name: prism-console-prod-workers
        provider: aws-ecs
        cluster: prism-shared-prod
        service: prism-console-workers
        region: us-east-1
        taskDefinition: prism-console-workers
        release:
          strategy: blue-green
          bakeTimeMinutes: 30
          approvals:
            - stakeholder: platform-lead
          alarms:
            - arn: arn:aws:cloudwatch:us-east-1:123456789012:alarm:prism-console-worker-errors-prod
      - name: status-site
        provider: fly.io
        app: prism-console-status
        region: iad
        release:
          strategy: rolling
          resources:
            cpu: shared-cpu-1x
            memoryMB: 256
        artifact:
          type: static-site
          path: infra/status-site/public
        endpoints:
          - type: https
            url: "https://status.blackroad.io"
      - name: roadview-search-prod
        provider: aws-ecs
        cluster: prism-shared-prod
        service: roadview-search
        region: us-east-1
        taskDefinition: roadview-search
        release:
          strategy: blue-green
          bakeTimeMinutes: 30
          approvals:
            - stakeholder: platform-lead
            - stakeholder: product-roadview
        endpoints:
          - type: https
            url: "https://roadview.blackroad.io"
        healthChecks:
          - path: /healthz
            intervalSeconds: 60
      - name: backroad-prod
        provider: nextjs-sim
        enabled: false
        notes: BackRoad is intentionally hidden behind a feature flag pending trust review.
      - name: lucidia-briefing-prod
        provider: docs-only
        enabled: false
        notes: Lucidia prompts are published as static documentation only.
      - name: roadwork-prod
        provider: docs-only
        enabled: false
        notes: RoadWork portal exposes read-only guides; authoring is disabled.
      - name: roadglitch-prod
        provider: feature-flag
        enabled: false
        notes: Chaos toggles remain disabled in production; only operator docs are published.
      - name: roadcoin-simulation-prod
        provider: simulation
        enabled: false
        mode: simulation-only
        notes: RoadCoin remains a simulation-only experience with no wallet custody or chain connectivity.
    policies:
      promotion:
        requires:
          - checklist: release-manager-approval
          - checklist: change-advisory-signoff
          - status: observability-green
      rollback:
        runbook: RUNBOOK.md#production-rollbacks
    compliance:
      dataResidency: us
      incidentComms:
        slackChannel: "#status"
        statusPage: infra/status-site/README.md
