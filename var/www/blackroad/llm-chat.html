<!-- FILE: /var/www/blackroad/llm-chat.html -->
<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Lucidia LLM</title>
    <style>
      body {
        font-family: sans-serif;
        background: #0b1324;
        color: #fff;
        margin: 20px;
      }
      .pill {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 12px;
        margin-right: 6px;
        font-size: 12px;
      }
      .pill.green {
        background: #008c76;
      }
      .pill.amber {
        background: #fdba2d;
        color: #000;
      }
      textarea {
        width: 100%;
        min-height: 80px;
        background: #09122a;
        color: #fff;
        border: 1px solid #444;
        border-radius: 8px;
        padding: 8px;
      }
      #messages {
        max-height: 300px;
        overflow: auto;
        border: 1px solid #444;
        border-radius: 8px;
        padding: 8px;
        margin-top: 10px;
        white-space: pre-wrap;
      }
    </style>
  </head>
  <body>
    <div id="pills">
      <span id="health" class="pill amber">offline</span>
      <span id="self" class="pill amber" title="self">self: unknown</span>
    </div>
    <div id="messages"></div>
    <div style="margin-top: 10px; display: flex; align-items: center; gap: 6px">
      <label class="pill" style="cursor: pointer">
        <input type="checkbox" id="streamToggle" checked /> Stream
      </label>
      <button id="sendBtn">Send</button>
    </div>
    <textarea id="input" placeholder="Say something..."></textarea>
    <div
      id="snapshot"
      style="
        position: fixed;
        bottom: 5px;
        left: 5px;
        font-size: 12px;
        color: #ccc;
      "
    ></div>
    <script>
      async function updateHealth() {
        try {
          const r = await fetch('/api/llm/health');
          const j = await r.json();
          const el = document.getElementById('health');
          if (j.ok) {
            el.textContent = 'online';
            el.className = 'pill green';
          } else {
            el.textContent = 'offline';
            el.className = 'pill amber';
          }
        } catch (e) {
          const el = document.getElementById('health');
          el.textContent = 'offline';
          el.className = 'pill amber';
        }
      }
      async function updateSelf() {
        try {
          const r = await fetch('/api/codex/identity');
          const j = await r.json();
          const el = document.getElementById('self');
          const today = new Date().toISOString().slice(0, 10).replace(/-/g, '');
          const ok = j.code && j.code.startsWith('LUCIDIA-AWAKEN-' + today);
          el.textContent = ok ? 'self: verified' : 'self: unknown';
          el.className = 'pill ' + (ok ? 'green' : 'amber');
          el.title = j.host + ' â€¢ ' + j.model;
        } catch (e) {
          const el = document.getElementById('self');
          el.textContent = 'self: unknown';
          el.className = 'pill amber';
        }
      }
      async function updateSnapshot() {
        try {
          const r = await fetch('/api/backups/last');
          const j = await r.json();
          document.getElementById('snapshot').textContent =
            'last snapshot: ' + (j.time || 'never');
        } catch (e) {
          document.getElementById('snapshot').textContent =
            'last snapshot: n/a';
        }
      }
      updateHealth();
      updateSelf();
      updateSnapshot();
      setInterval(updateHealth, 15000);
      setInterval(updateSelf, 60000);
      const messagesEl = document.getElementById('messages');
      function addMessage(role, content) {
        const div = document.createElement('div');
        div.innerHTML = '<div class="pill">' + role + '</div>' + content;
        messagesEl.appendChild(div);
        messagesEl.scrollTop = messagesEl.scrollHeight;
        return div;
      }
      function setAssistantContent(target, content) {
        if (target) {
          target.innerHTML = '<div class="pill">assistant</div>' + content;
        } else {
          addMessage('assistant', content);
        }
      }
      async function send() {
        const input = document.getElementById('input');
        const text = input.value.trim();
        if (!text) return;
        input.value = '';
        addMessage('user', text);
        const stream = document.getElementById('streamToggle').checked;
        const body = { messages: [{ role: 'user', content: text }] };
        if (stream) {
          const streamBody = { ...body, stream: true };
          try {
            const res = await fetch('/api/llm/chat', {
              method: 'POST',
              headers: { 'content-type': 'application/json' },
              body: JSON.stringify(streamBody),
            });
            if (!res.ok) return fallback(body, text, null);
            const reader = res.body.getReader();
            const decoder = new TextDecoder();
            let buf = '';
            let bot = '';
            const last = addMessage('assistant', '');
            while (true) {
              const { value, done } = await reader.read();
              if (done) break;
              buf += decoder.decode(value, { stream: true });
              const parts = buf.split('\n\n');
              for (let i = 0; i < parts.length - 1; i++) {
                const line = parts[i].trim();
                if (line.startsWith('data: ')) {
                  const data = JSON.parse(line.slice(6));
                  if (data.delta) {
                    bot += data.delta;
                    last.innerHTML = '<div class="pill">assistant</div>' + bot;
                  }
                  if (data.done) {
                    return;
                  }
                }
              }
              buf = parts[parts.length - 1];
            }
          } catch (e) {
            return fallback(body, text, last);
          }
        } else {
          await fallback(body, text, null);
        }
      }
      async function fallback(body, original, target) {
        try {
          const nonStreamBody = { ...body, stream: false };
          const res = await fetch('/api/llm/chat', {
            method: 'POST',
            headers: { 'content-type': 'application/json' },
            body: JSON.stringify(nonStreamBody),
          });
          const type =
            (res.headers &&
              res.headers.get &&
              res.headers.get('content-type')) ||
            '';
          if (!res.ok) {
            let detail = '';
            if (type.includes('application/json')) {
              try {
                const err = await res.json();
                if (err && typeof err.error === 'string') {
                  detail = err.error;
                } else if (err && typeof err.message === 'string') {
                  detail = err.message;
                } else if (err) {
                  detail = JSON.stringify(err);
                }
              } catch (_) {
                /* ignore parse error */
              }
            } else {
              try {
                detail = await res.text();
              } catch (_) {
                detail = '';
              }
            }
            const note =
              'LLM fallback failed (' +
              res.status +
              ')' +
              (detail ? ' : ' + detail : '');
            setAssistantContent(target, note);
            return;
          }
          let payload;
          if (type.includes('application/json')) {
            payload = await res.json();
          } else {
            const txt = await res.text();
            try {
              payload = JSON.parse(txt);
            } catch (_) {
              payload = { content: txt };
            }
          }
          const choice = Array.isArray(payload && payload.choices)
            ? payload.choices.find(
                (c) => c && c.message && typeof c.message.content === 'string'
              )
            : null;
          if (choice) {
            setAssistantContent(target, choice.message.content);
            return;
          }
          if (
            payload &&
            payload.message &&
            typeof payload.message.content === 'string'
          ) {
            setAssistantContent(target, payload.message.content);
            return;
          }
          if (payload && typeof payload.content === 'string') {
            setAssistantContent(target, payload.content);
            return;
          }
          setAssistantContent(
            target,
            'LLM response did not include assistant content.'
          );
        } catch (e) {
          const msg =
            e && e.message
              ? 'LLM request failed: ' + e.message
              : 'LLM request failed.';
          setAssistantContent(target, msg);
        }
      }
      document.getElementById('sendBtn').onclick = send;
    </script>
  </body>
</html>
