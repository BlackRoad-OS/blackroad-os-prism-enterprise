name: Deploy Prism Console

on:
  push:
    branches:
      - dev
      - staging
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Build
        working-directory: frontend
        run: npm run build

      - name: Determine environment
        id: env
        run: |
          branch_name="${GITHUB_REF##*/}"
          if [[ "$branch_name" == "main" ]]; then
            echo "railway_env=prod" >> "$GITHUB_OUTPUT"
          elif [[ "$branch_name" == "staging" ]]; then
            echo "railway_env=staging" >> "$GITHUB_OUTPUT"
          else
            echo "railway_env=dev" >> "$GITHUB_OUTPUT"
          fi

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Deploy to Railway
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          railway up \
            --service prism-console-web \
            --environment ${{ steps.env.outputs.railway_env }} \
            --ci

      - name: Health check
        if: steps.env.outputs.railway_env != 'dev'
        env:
          TARGET_ENV: ${{ steps.env.outputs.railway_env }}
        run: |
          if [[ "$TARGET_ENV" == "staging" ]]; then
            url="https://staging.console.blackroad.systems/health"
          else
            url="https://console.blackroad.systems/health"
          fi
          echo "Checking $url"
          curl -fsSL "$url"
