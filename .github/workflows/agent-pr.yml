name: Agent PR Autopilot

on:
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      pr:
        description: 'PR number'
        required: false

jobs:
  autopilot:
    if: >-
      github.event_name == 'workflow_dispatch' || (
        github.event_name == 'issue_comment' &&
        github.event.issue.pull_request &&
        github.event.comment.user.login != 'blackboxprogramming' &&
        github.event.comment.user.login != 'github-actions[bot]'
      )
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@b39b52d1213e96004bfcb1c61a8a6fa8ab84f3e8 # v4
        with:
          node-version: '20'

      - name: Run PR autopilot
        env:
          GH_TOKEN: ${{ secrets.GITHUB_PAT != '' && secrets.GITHUB_PAT || secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_PAT != '' && secrets.GITHUB_PAT || secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.issue.number || inputs.pr || '' }}
          COMMENT_BODY: ${{ github.event.comment.body || '' }}
          COMMENT_AUTHOR: ${{ github.event.comment.user.login || '' }}
          AUTOPILOT_USER: blackboxprogramming
          GITHUB_ACTOR: ${{ github.actor }}
        run: npx tsx scripts/agents/pr_autopilot.ts
