name: Deploy Prod
on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Block if protections relaxed
      - name: Check console health
        run: |
          curl --fail --retry 10 --retry-connrefused --retry-delay 15 https://prism.blackroad.io/healthz
      - name: Check RoadView search health
        run: |
          set -e
          strict=$(gh api repos/${{ github.repository }}/branches/main/protection --jq '.required_status_checks.strict' || echo false)
          admins=$(gh api repos/${{ github.repository }}/branches/main/protection --jq '.enforce_admins.enabled' || echo false)
          if [ "$strict" != "true" ] || [ "$admins" != "true" ]; then
            echo "❌ Protections relaxed. Aborting prod deploy."
            exit 1
          fi
      - name: Deploy
        run: |
          echo "Ship to prod here (k8s/ecs/fly) only when protections are strict"
          curl --fail --retry 10 --retry-connrefused --retry-delay 15 https://status.blackroad.io/
      - name: Enforce protections before prod
        run: |
          strict=$(gh api repos/${{ github.repository }}/branches/main/protection --jq '.required_status_checks.strict' || echo false)
          admins=$(gh api repos/${{ github.repository }}/branches/main/protection --jq '.enforce_admins.enabled' || echo false)
          [ "$strict" = "true" ] && [ "$admins" = "true" ] || { echo "❌ Protections not strict"; exit 1; }
      - name: Canary to prod (10%)
        run: |
          kubectl apply -k infra/k8s/overlays/prod-canary
      - name: Bake & watch
        run: |
          sleep 120
          curl -fsS https://api.yourdomain/health || { echo "❌ Canary health"; exit 1; }
      - name: Promote to 100%
        run: |
          kubectl apply -k infra/k8s/overlays/prod
