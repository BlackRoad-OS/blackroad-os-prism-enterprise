name: Escalate stale PRs

on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:

permissions:
  issues: write
  pull-requests: write
  contents: read

concurrency:
  group: escalate-no-review
  cancel-in-progress: true

jobs:
  escalate:
    runs-on: ubuntu-latest
    steps:
      - name: Flag PRs without reviews for 24h
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7
        env:
          THRESHOLD_HOURS: "24"
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const {owner, repo} = context.repo;
            const hours = parseInt(process.env.THRESHOLD_HOURS ?? '24', 10);
            const horizon = Date.now() - hours * 60 * 60 * 1000;
            const pulls = await github.paginate(github.rest.pulls.list, {
              owner,
              repo,
              state: 'open',
              per_page: 100,
            });
            for (const pr of pulls) {
              if (pr.draft) continue;
              if (new Date(pr.updated_at).getTime() > horizon) continue;
              const reviews = await github.rest.pulls.listReviews({
                owner,
                repo,
                pull_number: pr.number,
                per_page: 1,
              });
              if (reviews.data.length) continue;
              const marker = '(Escalation: no review in 24h)';
              const body = `Heads up: escalating for visibility ${marker}`;
              const comments = await github.paginate(github.rest.issues.listComments, {
                owner,
                repo,
                issue_number: pr.number,
                per_page: 100,
              });
              const existing = comments.find(
                (c) => c.user?.type === 'Bot' && c.body?.includes(marker),
              );
              if (existing) {
                await github.rest.issues.updateComment({
                  owner,
                  repo,
                  comment_id: existing.id,
                  body,
                });
              } else {
                await github.rest.issues.createComment({
                  owner,
                  repo,
                  issue_number: pr.number,
                  body,
                });
              }
            }
