name: CI (deterministic + flakes + caches)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
    branches: ['main']
  workflow_dispatch:

env:
  DOCKER_BUILDKIT: "1"
  PKG_MANAGER: pnpm
  TEST_CMD: "pnpm -r test --if-present"
  FLAKE_RERUNS: "3"

jobs:
  ci:
# Stack summary:
# - Frontend: React + Vite (Node 20, npm workspace at ./frontend)
# - Tests: npm run test (currently runs the Vite build until dedicated tests exist)
name: CI

on:
  pull_request:
    branches: ["main"]
  push:
    branches: ["main"]

permissions:
  contents: read

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  frontend:
    name: Frontend (Node 20)
    runs-on: ubuntu-latest
    timeout-minutes: 30

    permissions:
      contents: read
      actions: read
      checks: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: ${{ env.PKG_MANAGER }}

      - name: Ensure pnpm is available
        if: env.PKG_MANAGER == 'pnpm'
        run: |
          corepack enable
          if ! command -v pnpm >/dev/null 2>&1; then
            npm install -g pnpm
          fi

      - name: Restore Docker Buildx cache
        uses: actions/cache@v4
        with:
          path: |
            /tmp/.buildx-cache
            /tmp/.buildx-cache-new
          key: buildx-${{ runner.os }}-${{ hashFiles('**/Dockerfile', '**/package-lock.json', '**/pnpm-lock.yaml', '**/yarn.lock') }}
          restore-keys: |
            buildx-${{ runner.os }}-

      - name: Install deps (frozen)
        run: |
          set -e
          case "${PKG_MANAGER}" in
            npm)  npm ci ;;
            pnpm) pnpm install --frozen-lockfile ;;
            yarn) yarn install --frozen-lockfile ;;
            *)    echo "Unsupported PKG_MANAGER=${PKG_MANAGER}" && exit 1 ;;
          esac

      - name: Lint (optional)
        run: |
          if [ -f package.json ]; then
            if jq -e '.scripts.lint' package.json >/dev/null 2>&1; then
              $PKG_MANAGER run lint
            else
              echo "No lint script; skipping."
            fi
          else
            echo "No package.json; skipping lint."
          fi

      - name: Run tests with flake sampling
        id: testloop
        run: |
          set -e
          PASSES=0
          FAILS=0
          for i in $(seq 1 $FLAKE_RERUNS); do
            echo "▶ Test run #$i"
            if ${TEST_CMD}; then
              PASSES=$((PASSES+1))
            else
              FAILS=$((FAILS+1))
            fi
          done
          echo "passes=$PASSES" >> "$GITHUB_OUTPUT"
          echo "fails=$FAILS" >> "$GITHUB_OUTPUT"
          [ "$FAILS" -eq 0 ]

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements-dev.txt ]; then
            pip install -r requirements-dev.txt
          elif [ -f requirements.txt ]; then
            pip install -r requirements.txt
          elif [ -f pyproject.toml ]; then
            pip install .
          else
            echo "No Python dependency manifest detected; skipping install."
          fi

      - name: Run Python tests
        run: pytest -q

      - name: Annotate flake signal
        if: failure() || steps.testloop.outputs.fails != '0'
        uses: actions/github-script@v7
        env:
          PASSES: ${{ steps.testloop.outputs.passes }}
          FAILS: ${{ steps.testloop.outputs.fails }}
        with:
          script: |
            const passes = Number(process.env.PASSES || '0');
            const fails = Number(process.env.FAILS || '0');
            const summary = `Flake detector: ${passes} pass(es), ${fails} fail(s).` +
              (fails > 0 ? " Some tests flipped on retry — investigate nondeterminism." : "");
            await github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: "Flake signal",
              head_sha: context.sha,
              status: "completed",
              conclusion: fails > 0 ? "neutral" : "success",
              output: {
                title: "Flake sampling results",
                summary
              }
            });

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build (use/push cache)
        uses: docker/build-push-action@v6
        with:
          context: .
          push: false
          load: false
          tags: local/app:ci
          cache-from: |
            type=local,src=/tmp/.buildx-cache
          cache-to: |
            type=local,dest=/tmp/.buildx-cache-new,mode=max
          provenance: false

      - name: Finalize Docker cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache
      - uses: actions/checkout@v4
      - run: corepack enable || true
      - run: pnpm -v || npm i -g pnpm
      - run: pnpm install --ignore-scripts || npm install
      - run: |
          if command -v pnpm >/dev/null 2>&1; then
            pnpm -r build
          else
            npm run build --workspaces
          fi
      - name: Enable corepack
        run: corepack enable
        continue-on-error: true
      - name: Ensure pnpm is available
        run: pnpm -v || npm i -g pnpm
      - name: Install dependencies
        run: pnpm install --ignore-scripts || npm install
      - name: Build all packages
        run: pnpm -r build || npm run build --workspaces

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: corepack enable || true
      - run: pnpm -v || npm i -g pnpm
      - run: pnpm install --ignore-scripts || npm install
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - run: python -m pip install --upgrade pip
      - run: pip install -e '.[dev]'
      - run: |
          if command -v pnpm >/dev/null 2>&1; then
            pnpm -r test --if-present
          else
            npm test --workspaces
          fi
      - run: pytest -q
      - name: Enable corepack
        run: corepack enable
        continue-on-error: true
      - name: Ensure pnpm is available
        run: pnpm -v || npm i -g pnpm
      - name: Install dependencies
        run: pnpm install --ignore-scripts || npm install
      - name: Run JavaScript tests
        run: pnpm -r test --if-present || npm test --workspaces
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
      - name: Run Python tests
        run: pytest -q

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Enable corepack
        run: corepack enable
        continue-on-error: true
      - name: Ensure pnpm is available
        run: pnpm -v || npm i -g pnpm
      - name: Install dependencies
        run: pnpm install --ignore-scripts || npm install
      - name: Run ESLint
        run: pnpm dlx eslint . --ext .ts,.tsx,.js

  policy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: echo "opa eval would run here" # placeholder; keep alias 'policy'
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: |
            package-lock.json
            frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build

      - name: Run tests
        run: npm run test
        # TODO: Update this command when dedicated unit/integration tests are available.
      - name: Policy check placeholder
        run: echo "opa eval would run here" # placeholder; keep alias 'policy'
      - name: Deploy (SSH + atomic symlinks + rollback)
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SSH_KEY: ${{ secrets.SSH_KEY }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
          # Deploy + targets (match your known paths)
          DEPLOY_ROOT: /opt/blackroad/releases
          WEB_PATH: /var/www/blackroad
          API_PATH: /srv/blackroad-api
          # Health checks (external)
          HEALTH_URL: https://blackroad.io/health
          API_HEALTH_URL: https://blackroad.io/api/health
          RELEASE: ${{ github.sha }}
          KEEP_RELEASES: '3'
          DO_API_DEPLOY: '1'
        run: |
          chmod +x scripts/deploy.sh
          ./scripts/deploy.sh release.tar.gz
