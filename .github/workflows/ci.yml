name: CI (deterministic + flakes + caches)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  DOCKER_BUILDKIT: "1"
  PKG_MANAGER: pnpm
  TEST_CMD: "pnpm -r test --if-present"
  FLAKE_RERUNS: "3"

jobs:
  ci:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    permissions:
      contents: read
      actions: read
      checks: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: ${{ env.PKG_MANAGER }}

      - name: Restore Docker Buildx cache
        uses: actions/cache@v4
        with:
          path: |
            /tmp/.buildx-cache
            /tmp/.buildx-cache-new
          key: buildx-${{ runner.os }}-${{ hashFiles('**/Dockerfile', '**/package-lock.json', '**/pnpm-lock.yaml', '**/yarn.lock') }}
          restore-keys: |
            buildx-${{ runner.os }}-

      - name: Install deps (frozen)
        run: |
          set -e
          case "${PKG_MANAGER}" in
            npm)  npm ci ;;
            pnpm) pnpm install --frozen-lockfile ;;
            yarn) yarn install --frozen-lockfile ;;
            *)    echo "Unsupported PKG_MANAGER=${PKG_MANAGER}" && exit 1 ;;
          esac

      - name: Lint (optional)
        run: |
          if [ -f package.json ]; then
            if jq -e '.scripts.lint' package.json >/dev/null 2>&1; then
              $PKG_MANAGER run lint
            else
              echo "No lint script; skipping."
            fi
          else
            echo "No package.json; skipping lint."
          fi

      - name: Run tests with flake sampling
        id: testloop
        run: |
          set -e
          PASSES=0
          FAILS=0
          for i in $(seq 1 $FLAKE_RERUNS); do
            echo "▶ Test run #$i"
            if ${TEST_CMD}; then
              PASSES=$((PASSES+1))
            else
              FAILS=$((FAILS+1))
            fi
          done
          echo "passes=$PASSES" >> "$GITHUB_OUTPUT"
          echo "fails=$FAILS" >> "$GITHUB_OUTPUT"
          [ "$FAILS" -eq 0 ]

      - name: Annotate flake signal
        if: failure() || steps.testloop.outputs.fails != '0'
        uses: actions/github-script@v7
        env:
          PASSES: ${{ steps.testloop.outputs.passes }}
          FAILS: ${{ steps.testloop.outputs.fails }}
        with:
          script: |
            const passes = Number(process.env.PASSES || '0');
            const fails = Number(process.env.FAILS || '0');
            const summary = `Flake detector: ${passes} pass(es), ${fails} fail(s).` +
              (fails > 0 ? " Some tests flipped on retry — investigate nondeterminism." : "");
            await github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: "Flake signal",
              head_sha: context.sha,
              status: "completed",
              conclusion: fails > 0 ? "neutral" : "success",
              output: {
                title: "Flake sampling results",
                summary
              }
            });

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build (use/push cache)
        uses: docker/build-push-action@v6
        with:
          context: .
          push: false
          load: false
          tags: local/app:ci
          cache-from: |
            type=local,src=/tmp/.buildx-cache
          cache-to: |
            type=local,dest=/tmp/.buildx-cache-new,mode=max
          provenance: false

      - name: Finalize Docker cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache
