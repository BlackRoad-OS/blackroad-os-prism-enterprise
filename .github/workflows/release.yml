name: Release & Publish Image
on:
  push:
    branches: [main]
permissions:
  contents: write
  packages: write
  issues: write
jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4
        with: { fetch-depth: 0 }
      - uses: actions/setup-node@b39b52d1213e96004bfcb1c61a8a6fa8ab84f3e8 # v4
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }
      - uses: actions/setup-node@v4
        with: { node-version: '20' }
      - run: npm ci --prefix apps/api
      - name: Semantic Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN || '' }}
        run: npx --yes semantic-release
      - name: Log version
        id: getver
        run: |
          VER=$(jq -r '.version' apps/api/package.json || echo "0.0.0")
          echo "ver=$VER" >> $GITHUB_OUTPUT
      - name: Login ghcr
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
      - name: Build image
        run: docker build -t ghcr.io/${{ github.repository_owner }}/blackroad-api:${{ steps.getver.outputs.ver }} -t ghcr.io/${{ github.repository_owner }}/blackroad-api:latest apps/api
      - name: Push image
        run: docker push ghcr.io/${{ github.repository_owner }}/blackroad-api --all-tags
name: release
on:
  push:
    tags: ['v*.*.*']
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4
      - uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b # v5
        with: { python-version: '3.11' }
      - run: python -m pip install -U pip pytest jsonschema
      - run: python -m pip install -e .
      - run: pytest -q
      - name: Demo + Hash
        run: |
          python -m cli.console plm:items:load --dir fixtures/plm/items
          python -m cli.console plm:bom:load --dir fixtures/plm/boms
          python -m cli.console mfg:wc:load --file fixtures/mfg/work_centers.csv
          python -m cli.console mfg:routing:load --dir fixtures/mfg/routings
          python -m cli.console mfg:routing:capcheck --item PROD-100 --rev B --qty 1000
          python -m cli.console mfg:wi:render --item PROD-100 --rev B
          python -m cli.console mfg:spc:analyze --op OP-200 --window 50
          python -m cli.console mfg:yield --period 2025-09
          python -m cli.console mfg:mrp --demand artifacts/sop/allocations.csv --inventory fixtures/mfg/inventory.csv --pos fixtures/mfg/open_pos.csv
          python -m cli.console mfg:coq --period 2025-Q3
          bash scripts/hash_artifacts.sh || true
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: public/artifacts.sha256

