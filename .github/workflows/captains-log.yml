name: Captain's Log

on:
  schedule:
    - cron: "0 14 * * 5"   # Fridays 14:00 UTC
  workflow_dispatch:

permissions:
  contents: read
  issues: read
  pull-requests: read

jobs:
  build-log:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Gather repo signals
        id: gather
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          since="$(date -u -d '7 days ago' +%Y-%m-%dT%H:%M:%SZ)"
          now="$(date -u +%Y-%m-%dT%H:%M:%SZ)"

          # Commits (default branch)
          default_branch=$(gh repo view --json defaultBranchRef -q .defaultBranchRef.name)
          commits_json=$(gh api repos/{owner}/{repo}/commits \
            -f sha="$default_branch" -f since="$since" -f until="$now")

          # Issues/PRs updated
          issues_json=$(gh search issues --repo "$GITHUB_REPOSITORY" \
            --updated ">$since" --json number,title,state,updatedAt,author,isPullRequest,url)

          # Latest workflow runs (CI)
          ci_json=$(gh api repos/{owner}/{repo}/actions/runs?per_page=30)

          # Save artifacts
          echo "$commits_json" > /tmp/commits.json
          echo "$issues_json"  > /tmp/issues.json
          echo "$ci_json"      > /tmp/ci.json

          # Simple PII redaction (emails, phone-ish)
          redact() { sed -E 's/[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}/[redacted-email]/g;s/\+?[0-9][0-9(). -]{7,}[0-9]/[redacted-phone]/g'; }
          jq -r '.' /tmp/commits.json | redact > /tmp/commits.redacted.json
          jq -r '.' /tmp/issues.json  | redact > /tmp/issues.redacted.json
          jq -r '.' /tmp/ci.json      | redact > /tmp/ci.redacted.json

          # Render Markdown from template
          digest_path="$(python3 - << 'PY'
import json, os, datetime, textwrap
from pathlib import Path
now = datetime.datetime.utcnow()
week = now.strftime("%Y-%m-%d")
repo = os.environ["GITHUB_REPOSITORY"]
def load(p): return json.load(open(p))
commits = load("/tmp/commits.redacted.json")
issues  = load("/tmp/issues.redacted.json")
ci      = load("/tmp/ci.redacted.json")

# Summaries
commit_lines = [f"- {c['sha'][:7]} {c['commit']['message'].splitlines()[0]} ({c['html_url']})"
                for c in commits[:50]]

issue_lines = []
for i in issues[:50]:
    tag = "PR" if i.get("isPullRequest") else "Issue"
    issue_lines.append(f"- [{tag}] #{i['number']}: {i['title']} — {i['state']} ({i['url']})")

ci_runs = []
for r in ci.get("workflow_runs", [])[:15]:
    ci_runs.append(f"- {r['name']} #{r['run_number']} — {r['conclusion'] or r['status']} ({r['html_url']})")

template = Path(".github/captains-log.template.md").read_text()
out = template.format(
    REPO=repo, WEEK=week,
    COMMITS="\n".join(commit_lines) or "_None_",
    ISSUES="\n".join(issue_lines) or "_None_",
    CI="\n".join(ci_runs) or "_None_"
)

out_path = Path(f"captains-log/captains-log-{week}.md")
out_path.parent.mkdir(parents=True, exist_ok=True)
out_path.write_text(out)
print(out_path)
PY
)"
          echo "Digest generated at $digest_path"
          echo "digest_path=$digest_path" >> $GITHUB_OUTPUT

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: weekly-captains-log
          path: ${{ steps.gather.outputs.digest_path }}

      - name: Post to Slack (webhook)
        if: ${{ always() }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}  # store in repo/org secrets
        run: |
          summary="$(sed -n '1,80p' ${{ steps.gather.outputs.digest_path }})"
          heading="Weekly Captain's Log for *"
          closing="(Full digest committed as artifact)"
          payload=$(jq -Rn --slurp --arg heading "$heading" --arg repo "$GITHUB_REPOSITORY" --arg summary "$summary" --arg closing "$closing" \
            '{text: ($heading + $repo + "*:\n\n" + $summary + "\n\n" + $closing)}')
          curl -X POST -H 'Content-type: application/json' --data "$payload" "$SLACK_WEBHOOK_URL"
