name: Auto route mentions

on:
  workflow_call:
    inputs:
      routes_yaml_path:
        description: Path to the mention routing configuration file.
        required: false
        type: string
        default: ".github/mention-routes.yml"

permissions:
  contents: read
  pull-requests: write
  issues: write
  statuses: write
  id-token: none

jobs:
  route:
    if: github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    outputs:
      mentions: ${{ steps.route.outputs.mentions }}
      has_mentions: ${{ steps.route.outputs.has_mentions }}
    steps:
      - name: Checkout base branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.base.ref }}

      - name: Route mentions
        id: route
        uses: ./.github/actions/route-mentions
        with:
          routes_yaml_path: ${{ inputs.routes_yaml_path }}

      - name: Request routed team reviewers
        if: ${{ steps.route.outputs.has_mentions == 'true' }}
        uses: actions/github-script@v7
        env:
          MENTIONS: ${{ steps.route.outputs.mentions }}
        with:
          script: |
            const mentions = (process.env.MENTIONS || '').trim();
            if (!mentions) {
              core.info('No mentions to evaluate for reviewer requests.');
              return;
            }

            const mentionTokens = Array.from(new Set(mentions.split(/\s+/).filter(Boolean)));
            const teamRegex = /^@([^/\s]+)\/([^/\s]+)$/;
            const { owner, repo } = context.repo;
            const pr = context.payload.pull_request;
            if (!pr) {
              core.info('No pull request context; skipping reviewer requests.');
              return;
            }

            const routedTeams = new Map();
            for (const token of mentionTokens) {
              const match = token.match(teamRegex);
              if (!match) {
                continue;
              }
              const [, org, teamSlug] = match;
              if (org.toLowerCase() !== owner.toLowerCase()) {
                core.info(`Skipping team mention outside repository org: ${token}`);
                continue;
              }
              const lower = teamSlug.toLowerCase();
              if (!routedTeams.has(lower)) {
                routedTeams.set(lower, teamSlug);
              }
            }

            if (!routedTeams.size) {
              core.info('No in-organization team mentions found; skipping reviewer requests.');
              return;
            }

            let prData;
            try {
              ({ data: prData } = await github.rest.pulls.get({
                owner,
                repo,
                pull_number: pr.number
              }));
            } catch (error) {
              core.warning(`Failed to load pull request details: ${error.message}`);
              return;
            }

            const alreadyRequested = new Set(
              (prData.requested_teams || []).map(team => team.slug.toLowerCase())
            );
            const teamReviewers = [];
            for (const [lower, slug] of routedTeams.entries()) {
              if (alreadyRequested.has(lower)) {
                core.info(`Team ${slug} already requested; skipping.`);
                continue;
              }
              teamReviewers.push(slug);
            }

            if (!teamReviewers.length) {
              core.info('All routed teams already requested; nothing to do.');
              return;
            }

            try {
              await github.rest.pulls.requestReviewers({
                owner,
                repo,
                pull_number: pr.number,
                team_reviewers: teamReviewers
              });
              core.info(`Requested team reviewers: ${teamReviewers.join(', ')}`);
            } catch (error) {
              core.warning(`Failed to request team reviewers: ${error.message}`);
            }

      - name: Routing status check
        uses: actions/github-script@v7
        env:
          HAS_MENTIONS: ${{ steps.route.outputs.has_mentions }}
          MENTIONS: ${{ steps.route.outputs.mentions }}
        with:
          script: |
            const { owner, repo } = context.repo;
            const pr = context.payload.pull_request;
            if (!pr) {
              core.info('No pull request payload detected; skipping status.');
              return;
            }
            const sha = pr.head.sha;
            const hasMentions = process.env.HAS_MENTIONS === 'true';
            const description = hasMentions
              ? `Mentions posted: ${process.env.MENTIONS}`
              : 'No mentions matched';
            await github.rest.repos.createCommitStatus({
              owner,
              repo,
              sha,
              state: 'success',
              context: 'routing',
              description: description.slice(0, 140),
              target_url: `https://github.com/${owner}/${repo}/actions/runs/${context.runId}`
            });
