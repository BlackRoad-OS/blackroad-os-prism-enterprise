name: auto-queue-ready

on:
  workflow_run:
    workflows: ["build", "test", "lint", "security", "sbom", "policy", "eval"]
    types: [completed]

jobs:
  label-when-green:
    if: ${{ github.event.workflow_run.event == 'pull_request' && github.event.workflow_run.pull_requests }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      checks: read
    steps:
      - name: Synchronise queue label with required checks
        uses: actions/github-script@v7
        with:
          script: |
            const required = ["build", "test", "lint", "security", "sbom", "policy", "eval"];
            const pull = context.payload.workflow_run.pull_requests?.[0];
            if (!pull) {
              core.info("No pull request associated with this workflow_run. Exiting.");
              return;
            }

            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const number = pull.number;
            const sha = context.payload.workflow_run.head_sha;

            const { data } = await github.rest.checks.listForRef({
              owner,
              repo,
              ref: sha,
              filter: "latest"
            });

            const successful = new Set(
              data.check_runs.filter(run => run.conclusion === "success").map(run => run.name)
            );

            const allGreen = required.every(name => successful.has(name));
            const label = "queue:ready";

            if (allGreen) {
              await github.rest.issues.addLabels({ owner, repo, issue_number: number, labels: [label] });
              core.info(`Applied ${label} to #${number}`);
            } else {
              try {
                await github.rest.issues.removeLabel({ owner, repo, issue_number: number, name: label });
                core.info(`Removed ${label} from #${number}`);
              } catch (error) {
                if (error.status !== 404) {
                  throw error;
                }
                core.info(`${label} was not present on #${number}`);
              }
            }

