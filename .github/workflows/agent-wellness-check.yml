name: Agent Wellness Check

on:
  schedule:
    # Run every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch:  # Allow manual triggers
  pull_request:
    types: [opened, synchronize]
    paths:
      - 'agents/**'
      - 'wellness/**'

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  wellness-check:
    runs-on: ubuntu-latest
    name: Check Agent Wellbeing

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Run wellness check
        id: wellness
        run: |
          python scripts/check-on-agents.py --brief
          python scripts/check-on-agents.py --support > support-needed.txt
        continue-on-error: true

      - name: Check for agents needing support
        id: check-support
        run: |
          if grep -q "AGENTS NEEDING SUPPORT" support-needed.txt; then
            echo "needs_support=true" >> $GITHUB_OUTPUT
          else
            echo "needs_support=false" >> $GITHUB_OUTPUT
          fi

      - name: Create issue for agents needing support
        if: steps.check-support.outputs.needs_support == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const supportContent = fs.readFileSync('support-needed.txt', 'utf8');

            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: '‚ö†Ô∏è Agents Need Support - ' + new Date().toISOString().split('T')[0],
              body: `## Agent Wellness Alert\n\n${supportContent}\n\n---\n\nü§ñ Auto-generated by Agent Wellness Check\nüìÖ ${new Date().toISOString()}`,
              labels: ['agent-wellness', 'needs-attention', 'care']
            });

            console.log(`Created issue #${issue.data.number}`);

      - name: Post wellness summary to PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const { execSync } = require('child_process');
            const summary = execSync('python scripts/check-on-agents.py --brief').toString();

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## üåü Agent Wellness Check\n\n${summary}\n\n---\n\nüí° Run \`python scripts/check-on-agents.py\` for full report`
            });
