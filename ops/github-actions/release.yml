name: reusable-release

on:
  workflow_call:
    inputs:
      environment:
        type: string
        default: 'staging'
    secrets:
      REGISTRY_USERNAME:
        required: true
      REGISTRY_PASSWORD:
        required: true
      AWS_ACCESS_KEY_ID:
        required: false
      AWS_SECRET_ACCESS_KEY:
        required: false

jobs:
  versioning:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Bump version
        id: bump
        uses: mathieudutour/github-tag-action@v6.2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          release_branches: main
          default_bump: patch
      - name: Generate changelog
        run: echo "${{ steps.bump.outputs.changelog }}" > changelog.md
      - name: Upload changelog
        uses: actions/upload-artifact@v4
        with:
          name: changelog
          path: changelog.md

  promote-image:
    runs-on: ubuntu-latest
    needs: versioning
    env:
      IMAGE_TAG: ${{ github.sha }}
    steps:
      - uses: actions/checkout@v4
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_PASSWORD }}
      - name: Promote image
        run: |
          docker pull ghcr.io/${{ secrets.REGISTRY_USERNAME }}/svc-template-fastapi:${IMAGE_TAG}
          docker tag ghcr.io/${{ secrets.REGISTRY_USERNAME }}/svc-template-fastapi:${IMAGE_TAG} \
            ghcr.io/${{ secrets.REGISTRY_USERNAME }}/svc-template-fastapi:release-${{ inputs.environment }}
          docker push ghcr.io/${{ secrets.REGISTRY_USERNAME }}/svc-template-fastapi:release-${{ inputs.environment }}

  deploy-staging:
    runs-on: ubuntu-latest
    needs: promote-image
    environment:
      name: staging
      url: https://staging.example.com
    steps:
      - uses: actions/checkout@v4
      - name: Terraform apply
        run: |
          cd infra/terraform/aws
          terraform init
          terraform apply -auto-approve -var "image_tag=release-${{ inputs.environment }}"
      - name: Run load tests
        run: ./ops/scripts/run_load_tests.sh
      - name: Evaluate metrics
        run: ./ops/scripts/run_evals.py --spec ops/evals/smoke.json
      - name: OPA gate
        run: |
          opa eval --format pretty --data ops/policies/opa --input ops/github-actions/sample-input.json "data.deploy.allow"

  promote-prod:
    runs-on: ubuntu-latest
    needs: deploy-staging
    environment:
      name: production
      url: https://prod.example.com
    steps:
      - uses: actions/checkout@v4
      - name: Promote to production
        run: ./ops/scripts/promote_prod.sh
      - name: Notify
        run: ./ops/scripts/notify.sh "Production deploy succeeded"
